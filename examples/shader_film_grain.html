<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Alien.js â€” Post-processing Film Grain</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div id="root"></div>
    <script type="module">import{ACESFilmicToneMapping,AmbientLight,BloomCompositeMaterial,BlurDirectionX,BlurDirectionY,BoxBufferGeometry,BufferAttribute,BufferGeometry,Color,DirectionalLight,Events,FilmGrainFXAAMaterial,Group,HemisphereLight,LuminosityMaterial,MathUtils,Mesh,MeshStandardMaterial,NoBlending,OrthographicCamera,PlaneBufferGeometry,RGBFormat,RawShaderMaterial,Scene,Stage,Uniform,UnrealBloomBlurMaterial,Vector2,WebGL1Renderer,WebGLRenderTarget,getFullscreenTriangle,mix,ticker}from"../build/alien.js";class Config{}Config.BG_COLOR="#0e0e0e",Config.UI_COLOR="rgba(255, 255, 255, 0.94)";import rgbshift from"../src/shaders/modules/rgbshift/rgbshift.glsl.js";const vertexCompositeShader="\n            attribute vec2 uv;\n            attribute vec3 position;\n\n            varying vec2 vUv;\n\n            void main() {\n                vUv = uv;\n\n                gl_Position = vec4(position, 1.0);\n            }\n        ",fragmentCompositeShader=`\n            precision highp float;\n\n            uniform sampler2D tScene;\n            uniform sampler2D tBloom;\n            uniform float uDistortion;\n\n            varying vec2 vUv;\n\n            ${rgbshift}\n\n            void main() {\n                gl_FragColor = texture2D(tScene, vUv);\n\n                float angle = length(vUv - vec2(0.5));\n                float amount = uDistortion + 0.0002;\n\n                gl_FragColor.rgb += getRGB(tBloom, vUv, angle, amount).rgb;\n            }\n        `;class CompositeMaterial extends RawShaderMaterial{constructor(){super({uniforms:{tScene:new Uniform(null),tBloom:new Uniform(null),uDistortion:new Uniform(.00125)},vertexShader:vertexCompositeShader,fragmentShader:fragmentCompositeShader,blending:NoBlending,depthWrite:!1,depthTest:!1})}}class SceneView extends Group{constructor(){super(),this.initMesh()}initMesh(){this.material=new MeshStandardMaterial({metalness:1});const e=new BoxBufferGeometry(50,50,300),r=new Mesh(e,this.material);this.add(r);const t=new BoxBufferGeometry(50,250,50),n=new Mesh(t,this.material);n.position.set(0,150,125),this.add(n);const i=new BoxBufferGeometry(150,50,50),a=new Mesh(i,this.material);a.position.set(100,250,125),this.add(a);const o=new PlaneBufferGeometry(50,50,32),s=new Mesh(o,this.material);s.position.set(200,275,125),s.rotation.x=MathUtils.degToRad(-90),this.add(s);const l=new BufferGeometry,d=new Float32Array([0,0,0,50,0,0,0,50,0]),h=new Float32Array([0,0,1,0,0,1]);l.setAttribute("position",new BufferAttribute(d,3)),l.setAttribute("uv",new BufferAttribute(h,2)),l.computeVertexNormals();const u=new Mesh(l,this.material);u.position.set(175,275,150),u.scale.y=-1,this.add(u),this.position.y=-62.5}}class RenderManager{static init(e,r,t){this.renderer=e,this.scene=r,this.camera=t,this.grainEffect=.15,this.luminosityThreshold=.1,this.bloomStrength=.3,this.bloomRadius=.75,this.enabled=!0,this.initRenderer()}static initRenderer(){const{resolution:e,screenTriangle:r,time:t}=WorldController;this.screenScene=new Scene,this.screenCamera=new OrthographicCamera(-1,1,1,-1,0,1),this.screen=new Mesh(r),this.screen.frustumCulled=!1,this.screenScene.add(this.screen),this.renderTargetA=new WebGLRenderTarget(1,1,{format:RGBFormat,anisotropy:0,depthBuffer:!1}),this.renderTargetB=this.renderTargetA.clone(),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5,this.renderTargetBright=this.renderTargetA.clone();for(let e=0,r=this.nMips;e<r;e++)this.renderTargetsHorizontal.push(this.renderTargetA.clone()),this.renderTargetsVertical.push(this.renderTargetA.clone());this.renderTargetA.depthBuffer=!0,this.fxaaMaterial=new FilmGrainFXAAMaterial,this.fxaaMaterial.uniforms.uIntensity.value=this.grainEffect,this.fxaaMaterial.uniforms.uResolution=e,this.fxaaMaterial.uniforms.uTime=t,this.luminosityMaterial=new LuminosityMaterial,this.luminosityMaterial.uniforms.uLuminosityThreshold.value=this.luminosityThreshold,this.blurMaterials=[];const n=[3,5,7,9,11];for(let e=0,r=this.nMips;e<r;e++)this.blurMaterials.push(new UnrealBloomBlurMaterial(n[e])),this.blurMaterials[e].uniforms.uResolution.value=new Vector2;const i=[1,.8,.6,.4,.2];for(let e=0,r=this.nMips;e<r;e++){const r=i[e];i[e]=this.bloomStrength*mix(r,1.2-r,this.bloomRadius)}this.bloomCompositeMaterial=new BloomCompositeMaterial(this.nMips),this.bloomCompositeMaterial.uniforms.tBlur1.value=this.renderTargetsVertical[0].texture,this.bloomCompositeMaterial.uniforms.tBlur2.value=this.renderTargetsVertical[1].texture,this.bloomCompositeMaterial.uniforms.tBlur3.value=this.renderTargetsVertical[2].texture,this.bloomCompositeMaterial.uniforms.tBlur4.value=this.renderTargetsVertical[3].texture,this.bloomCompositeMaterial.uniforms.tBlur5.value=this.renderTargetsVertical[4].texture,this.bloomCompositeMaterial.uniforms.uBloomFactors.value=i,this.compositeMaterial=new CompositeMaterial}}RenderManager.resize=(e,r,t)=>{RenderManager.renderer.setPixelRatio(t),RenderManager.renderer.setSize(e,r),e=Math.round(e*t),r=Math.round(r*t),RenderManager.renderTargetA.setSize(e,r),RenderManager.renderTargetB.setSize(e,r),e=Math.round(e/2),r=Math.round(r/2),RenderManager.renderTargetBright.setSize(e,r);for(let t=0,n=RenderManager.nMips;t<n;t++)RenderManager.renderTargetsHorizontal[t].setSize(e,r),RenderManager.renderTargetsVertical[t].setSize(e,r),RenderManager.blurMaterials[t].uniforms.uResolution.value.set(e,r),e=Math.round(e/2),r=Math.round(r/2)},RenderManager.update=()=>{const e=RenderManager.renderer,r=RenderManager.scene,t=RenderManager.camera;if(!RenderManager.enabled)return e.setRenderTarget(null),void e.render(r,t);const n=RenderManager.screenScene,i=RenderManager.screenCamera,a=RenderManager.renderTargetA,o=RenderManager.renderTargetB,s=RenderManager.renderTargetBright,l=RenderManager.renderTargetsHorizontal,d=RenderManager.renderTargetsVertical;e.setRenderTarget(a),e.render(r,t),RenderManager.fxaaMaterial.uniforms.tMap.value=a.texture,RenderManager.screen.material=RenderManager.fxaaMaterial,e.setRenderTarget(o),e.render(n,i),RenderManager.luminosityMaterial.uniforms.tMap.value=o.texture,RenderManager.screen.material=RenderManager.luminosityMaterial,e.setRenderTarget(s),e.render(n,i);let h=s;for(let r=0,t=RenderManager.nMips;r<t;r++)RenderManager.screen.material=RenderManager.blurMaterials[r],RenderManager.blurMaterials[r].uniforms.tMap.value=h.texture,RenderManager.blurMaterials[r].uniforms.uDirection.value=BlurDirectionX,e.setRenderTarget(l[r]),e.render(n,i),RenderManager.blurMaterials[r].uniforms.tMap.value=RenderManager.renderTargetsHorizontal[r].texture,RenderManager.blurMaterials[r].uniforms.uDirection.value=BlurDirectionY,e.setRenderTarget(d[r]),e.render(n,i),h=d[r];RenderManager.screen.material=RenderManager.bloomCompositeMaterial,e.setRenderTarget(l[0]),e.render(n,i),RenderManager.compositeMaterial.uniforms.tScene.value=o.texture,RenderManager.compositeMaterial.uniforms.tBloom.value=l[0].texture,RenderManager.screen.material=RenderManager.compositeMaterial,e.setRenderTarget(null),e.render(n,i)};class WorldController{static init(){this.initWorld(),this.initLights()}static initWorld(){this.renderer=new WebGL1Renderer({powerPreference:"high-performance",stencil:!1}),this.element=this.renderer.domElement,this.renderer.toneMapping=ACESFilmicToneMapping,this.renderer.toneMappingExposure=1,this.scene=new Scene,this.scene.background=new Color(Config.BG_COLOR),this.camera=new OrthographicCamera(-1,1,1,-1,0,1e3),this.camera.position.set(500,500,500),this.camera.lookAt(this.scene.position),this.screenTriangle=getFullscreenTriangle(),this.resolution=new Uniform(new Vector2),this.aspect=new Uniform(1),this.time=new Uniform(0),this.frame=new Uniform(0)}static initLights(){this.scene.add(new AmbientLight(16777215,2)),this.scene.add(new HemisphereLight(6316128,4210752));const e=new DirectionalLight(16777215,2);e.position.set(60,100,20),this.scene.add(e)}}WorldController.resize=(e,r,t)=>{WorldController.camera.left=-e/2,WorldController.camera.right=e/2,WorldController.camera.top=r/2,WorldController.camera.bottom=-r/2,WorldController.camera.updateProjectionMatrix(),e=Math.round(e*t),r=Math.round(r*t),WorldController.resolution.value.set(e,r),WorldController.aspect.value=e/r},WorldController.update=(e,r,t)=>{WorldController.time.value=e,WorldController.frame.value=t};class App{static async init(){this.initWorld(),this.initViews(),this.initControllers(),this.addListeners(),this.onResize()}static initWorld(){WorldController.init(),Stage.add(WorldController.element)}static initViews(){this.view=new SceneView,WorldController.scene.add(this.view)}static initControllers(){const{renderer:e,scene:r,camera:t}=WorldController;RenderManager.init(e,r,t)}static addListeners(){Stage.events.on(Events.RESIZE,this.onResize),ticker.add(this.onUpdate)}}App.onResize=()=>{const{width:e,height:r,dpr:t}=Stage;WorldController.resize(e,r,t),RenderManager.resize(e,r,t)},App.onUpdate=(e,r,t)=>{WorldController.update(e,r,t),RenderManager.update(e,r,t)},App.init();</script>
</body>
</html>
