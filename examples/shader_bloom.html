<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Alien.js â€” Post-processing Bloom</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div id="root"></div>
    <script type="module">import{BlurDirectionX,BlurDirectionY,BlurMaterial,Color,DirectionalLight,Events,FXAAMaterial,Group,HemisphereLight,Mesh,MeshStandardMaterial,NoBlending,OrthographicCamera,PerspectiveCamera,RGBFormat,RawShaderMaterial,Scene,SphereGeometry,Stage,Uniform,Vector2,WebGL1Renderer,WebGLRenderTarget,getFullscreenTriangle,ticker}from"../build/alien.js";class Config{}Config.BG_COLOR="#0e0e0e",Config.UI_COLOR="rgba(255, 255, 255, 0.94)";import periodic3d from"../src/shaders/modules/noise/periodic3d.glsl.js";const vertexShaderChunk="\n            float f = 0.05 * pnoise(vec3(2.0 * normal + time), vec3(10.0));\n            vec3 transformed = position + f * normal;\n        ",vertexCompositeShader="\n            attribute vec2 uv;\n            attribute vec3 position;\n\n            varying vec2 vUv;\n\n            void main() {\n                vUv = uv;\n\n                gl_Position = vec4(position, 1.0);\n            }\n        ",fragmentCompositeShader="\n            precision highp float;\n\n            uniform sampler2D tScene;\n            uniform sampler2D tBloom;\n            uniform float uMinBright;\n            uniform float uBlurBright;\n\n            varying vec2 vUv;\n\n            void main() {\n                gl_FragColor = texture2D(tScene, vUv);\n\n                vec3 bloom = texture2D(tBloom, vUv).rgb;\n                bloom.x = max(0.0, bloom.x - uMinBright);\n                bloom.y = max(0.0, bloom.y - uMinBright);\n                bloom.z = max(0.0, bloom.z - uMinBright);\n\n                gl_FragColor.rgb += bloom * uBlurBright;\n            }\n        ";class CompositeMaterial extends RawShaderMaterial{constructor(){super({uniforms:{tScene:new Uniform(null),tBloom:new Uniform(null),uMinBright:new Uniform(.1247),uBlurBright:new Uniform(.4166)},vertexShader:vertexCompositeShader,fragmentShader:fragmentCompositeShader,blending:NoBlending,depthWrite:!1,depthTest:!1})}}class SceneView extends Group{constructor(){super(),this.initMesh()}initMesh(){const{time:e}=WorldController,r=new SphereGeometry(1,80,80),n=new MeshStandardMaterial({roughness:0});n.onBeforeCompile=r=>{r.uniforms.time=e,r.vertexShader="uniform float time;\n"+periodic3d+r.vertexShader,r.vertexShader=r.vertexShader.replace("#include <begin_vertex>",vertexShaderChunk)};const t=new Mesh(r,n);this.add(t)}}class RenderManager{static init(e,r,n){this.renderer=e,this.scene=r,this.camera=n,this.blurResolutionScale=.25,this.blurFactor=6,this.enabled=!0,this.initRenderer()}static initRenderer(){const{resolution:e,screenTriangle:r}=WorldController;this.renderer.autoClear=!1,this.screenScene=new Scene,this.screenCamera=new OrthographicCamera(-1,1,1,-1,0,1),this.screen=new Mesh(r),this.screen.frustumCulled=!1,this.screenScene.add(this.screen),this.backgroundScene=new Scene,this.backgroundScene.background=new Color(Config.BG_COLOR),this.renderTargetA=new WebGLRenderTarget(1,1,{format:RGBFormat,anisotropy:0,depthBuffer:!1}),this.renderTargetB=this.renderTargetA.clone(),this.renderTargetBlurA=this.renderTargetA.clone(),this.renderTargetBlurB=this.renderTargetA.clone(),this.renderTargetA.depthBuffer=!0,this.fxaaMaterial=new FXAAMaterial,this.fxaaMaterial.uniforms.uResolution=e,this.hBlurMaterial=new BlurMaterial(BlurDirectionX),this.hBlurMaterial.uniforms.uResolution=e,this.vBlurMaterial=new BlurMaterial(BlurDirectionY),this.vBlurMaterial.uniforms.uResolution=e,this.compositeMaterial=new CompositeMaterial}}RenderManager.resize=(e,r,n)=>{RenderManager.renderer.setPixelRatio(n),RenderManager.renderer.setSize(e,r),e=Math.round(e*n),r=Math.round(r*n),RenderManager.renderTargetA.setSize(e,r),RenderManager.renderTargetB.setSize(e,r),e=Math.round(e*RenderManager.blurResolutionScale),r=Math.round(r*RenderManager.blurResolutionScale),RenderManager.renderTargetBlurA.setSize(e,r),RenderManager.renderTargetBlurB.setSize(e,r)},RenderManager.update=()=>{const e=RenderManager.renderer,r=RenderManager.scene,n=RenderManager.camera;if(!RenderManager.enabled)return e.setRenderTarget(null),e.clear(),void e.render(r,n);const t=RenderManager.blurFactor,a=RenderManager.screenScene,i=RenderManager.screenCamera,o=RenderManager.renderTargetA,l=RenderManager.renderTargetB,s=RenderManager.renderTargetBlurA,d=RenderManager.renderTargetBlurB;e.setRenderTarget(o),e.clear(),e.render(RenderManager.backgroundScene,n),e.setRenderTarget(o),e.render(r,n),RenderManager.fxaaMaterial.uniforms.tMap.value=o.texture,RenderManager.screen.material=RenderManager.fxaaMaterial,e.setRenderTarget(l),e.clear(),e.render(a,i),RenderManager.hBlurMaterial.uniforms.uBluriness.value=t,RenderManager.hBlurMaterial.uniforms.tMap.value=l.texture,RenderManager.screen.material=RenderManager.hBlurMaterial,e.setRenderTarget(s),e.clear(),e.render(a,i),RenderManager.vBlurMaterial.uniforms.uBluriness.value=t,RenderManager.vBlurMaterial.uniforms.tMap.value=s.texture,RenderManager.screen.material=RenderManager.vBlurMaterial,e.setRenderTarget(d),e.clear(),e.render(a,i),RenderManager.compositeMaterial.uniforms.tScene.value=l.texture,RenderManager.compositeMaterial.uniforms.tBloom.value=d.texture,RenderManager.screen.material=RenderManager.compositeMaterial,e.setRenderTarget(null),e.clear(),e.render(a,i)};class WorldController{static init(){this.initWorld(),this.initLights()}static initWorld(){this.renderer=new WebGL1Renderer({powerPreference:"high-performance",stencil:!1}),this.element=this.renderer.domElement,this.scene=new Scene,this.camera=new PerspectiveCamera(30),this.camera.near=.5,this.camera.far=50,this.camera.position.z=6,this.screenTriangle=getFullscreenTriangle(),this.resolution=new Uniform(new Vector2),this.aspect=new Uniform(1),this.time=new Uniform(0),this.frame=new Uniform(0)}static initLights(){this.scene.add(new HemisphereLight(6316128,4210752));const e=new DirectionalLight(16777215,.4);e.position.set(1,1,1),this.scene.add(e)}}WorldController.resize=(e,r,n)=>{WorldController.camera.aspect=e/r,WorldController.camera.updateProjectionMatrix(),e=Math.round(e*n),r=Math.round(r*n),WorldController.resolution.value.set(e,r),WorldController.aspect.value=e/r,WorldController.camera.position.z=e<r?10:6},WorldController.update=(e,r,n)=>{WorldController.time.value=e,WorldController.frame.value=n};class App{static async init(){this.initWorld(),this.initViews(),this.initControllers(),this.addListeners(),this.onResize()}static initWorld(){WorldController.init(),Stage.add(WorldController.element)}static initViews(){this.view=new SceneView,WorldController.scene.add(this.view)}static initControllers(){const{renderer:e,scene:r,camera:n}=WorldController;RenderManager.init(e,r,n)}static addListeners(){Stage.events.on(Events.RESIZE,this.onResize),ticker.add(this.onUpdate)}}App.onResize=()=>{const{width:e,height:r,dpr:n}=Stage;WorldController.resize(e,r,n),RenderManager.resize(e,r,n)},App.onUpdate=(e,r,n)=>{WorldController.update(e,r,n),RenderManager.update(e,r,n)},App.init();</script>
</body>
</html>
