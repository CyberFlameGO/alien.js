<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Alien.js â€” 3D Audio</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div id="root"></div>
    <script type="module">import{AssetLoader,Assets,Color,Device,DirectionalLight,EventEmitter,Events,Fog,Group,HemisphereLight,MathUtils,Mesh,MeshStandardMaterial,PerspectiveCamera,PointLight,Scene,Sound3D,SphereGeometry,Stage,Thread,Uniform,Vector2,Vector3,WebAudio,WebGL1Renderer,clamp,delayedCall,getFrustum,gsap,range,ticker}from"../build/alien.js";import{World}from"https://unpkg.com/oimo/build/oimo.module.js";class Config{}Config.BG_COLOR="#0e0e0e",Config.UI_COLOR="rgba(255, 255, 255, 0.94)",Config.ASSETS=["assets/sounds/gong.mp3"];class Global{}Global.BALL_X=22.5;class ScenePhysics extends EventEmitter{constructor(e){super(),this.resize=(e,t)=>{this.width=e,this.height=t},this.update=()=>{this.world.step();let e=0;this.bodies.forEach((t,s)=>{e=8*s,t.sleeping?this.buffer[e+7]=1:(this.buffer[e+7]=0,t.getPosition().toArray(this.buffer,e),t.getQuaternion().toArray(this.buffer,e+3))}),this.emit("update",{buffer:this.buffer});const t=this.bodies[0],s=this.bodies[1];this.mouse.lerp(this.target,this.lerpSpeed),this.malletPosition.x=this.mouse.x*(.5*this.width),this.malletPosition.y=this.mouse.y*(.5*this.height),this.malletPosition.z=s.position.z,s.setPosition(this.malletPosition);const i=this.world.getContact(s,t);if(i&&!this.timeout){this.force.x+=t.linearVelocity.x*t.mass-s.linearVelocity.x*s.mass,this.force.y+=t.linearVelocity.y*t.mass-s.linearVelocity.y*s.mass,this.force.z+=t.linearVelocity.z*t.mass-s.linearVelocity.z*s.mass,this.force.multiplyScalar(.5);const e=this.force.length();(e>150||!i.close)&&(this.timeout=!0,this.emit("contact",{force:e}),delayedCall(250,()=>{this.timeout=!1}))}},this.motion=({x:e,y:t})=>{this.target.set(2*e-1,-2*t+1)},this.shapes=e,this.bodies=[],this.force=new Vector3,this.mouse=new Vector2,this.target=new Vector2,this.malletPosition=new Vector3,this.timeout=!1,this.lerpSpeed=.25,this.initWorld()}initWorld(){this.world=new World,this.world.gravity=new Vector3(0,-98,0),this.shapes.forEach(e=>this.bodies.push(this.world.add(e)));const e=this.bodies[0];this.world.add({name:"body",pos:[0,3.75,0]}),this.world.add({type:"jointDistance",body1:"body",body2:"ball",pos1:[0,3.75,0],pos2:[0,3.75,0],min:0,max:e.pos.x/2}),e.linearVelocity.set(0,0,-25),this.buffer=new Float32Array(8*this.shapes.length)}}class ScenePhysicsThread{constructor(){this.onMessage=({data:e})=>{this[e.message.fn].call(this,e.message)},this.onUpdate=({buffer:e})=>{postMessage({event:"update",message:{buffer:e}})},this.onContact=({force:e})=>{postMessage({event:"contact",message:{force:e}})},this.init=({shapes:e})=>{this.physics=new ScenePhysics(e),this.physics.on("update",this.onUpdate),this.physics.on("contact",this.onContact),postMessage({event:"ready"})},this.resize=({width:e,height:t})=>{this.physics.resize(e,t)},this.update=()=>{this.physics.update()},this.motion=e=>{this.physics.motion(e)},this.addListeners()}addListeners(){addEventListener("message",this.onMessage)}}class ScenePhysicsController{constructor(e){this.onReady=()=>{this.resolve()},this.onUpdate=({buffer:e})=>{this.buffer=e},this.onContact=({force:e})=>{AudioController.trigger("gong",e)},this.resize=(e,t)=>{this.thread?this.thread.resize({width:e,height:t}):this.physics.resize(e,t)},this.update=()=>{this.physics&&this.physics.update();let e=0;this.meshes.forEach((t,s)=>{e=8*s,1!==this.buffer[e+7]&&(t.position.fromArray(this.buffer,e),t.quaternion.fromArray(this.buffer,e+3))})},this.send=(e,t={})=>{this.thread?this.thread.send(e,t):this.physics[e].call(this.physics,t)},this.ready=()=>this.promise,this.view=e,this.meshes=[],this.shapes=[],this.promise=new Promise(e=>this.resolve=e),this.initBuffer(),this.initEngine(),this.addListeners()}initBuffer(){const{ball:e,mallet:t}=this.view;this.meshes.push(e),this.shapes.push(this.createShapeObject("ball","sphere",e.position,e.rotation,e.size,!0)),this.meshes.push(t),this.shapes.push(this.createShapeObject("paddle","sphere",t.position,t.rotation,t.size,!0,!0)),this.buffer=new Float32Array(8*this.shapes.length)}initEngine(){Device.agent.includes("chrome")?(this.thread=new Thread({imports:[["../build/alien.js","EventEmitter","Vector2","Vector3","delayedCall"],["https://unpkg.com/oimo/build/oimo.module.js","World"]],classes:[ScenePhysics],controller:[ScenePhysicsThread,"init","resize","update"]}),this.thread.init({shapes:this.shapes})):this.physics=new ScenePhysics(this.shapes)}createShapeObject(e,t,s,i,o,n,r){const a={};a.name=e,a.type=t,a.pos=[s.x,s.y,s.z],a.rot=[MathUtils.radToDeg(i.x),MathUtils.radToDeg(i.y),MathUtils.radToDeg(i.z)],a.move=n,a.noSleep=n,"box"===t&&(a.size=[o.x,o.y,o.z]),"sphere"===t&&(a.size=[o.x]),"cylinder"===t&&(a.size=[o.x,o.z]);const h=[4,0,0,1,4294967295];return r&&(h[0]=100,a.kinematic=!0),a.config=h,a}addListeners(){this.thread?(this.thread.on("ready",this.onReady),this.thread.on("update",this.onUpdate),this.thread.on("contact",this.onContact)):(this.physics.on("update",this.onUpdate),this.physics.on("contact",this.onContact),this.resolve())}}class Mallet extends Group{constructor(){super(),this.position.z=6.25,this.initMesh(),this.initLight()}initMesh(){this.size=new Vector3(.5,.5,.5);const e=new SphereGeometry(.5,24,24),t=new MeshStandardMaterial({emissive:16777215}),s=new Mesh(e,t);this.add(s)}initLight(){const e=new PointLight(16777215,.2);this.add(e)}}class Ball extends Group{constructor(){super(),this.position.x=Global.BALL_X,this.initMesh()}initMesh(){this.size=new Vector3(1.25,1.25,1.25);const e=new SphereGeometry(1.25,32,32),t=new MeshStandardMaterial({color:Config.BG_COLOR,roughness:.3,metalness:1,dithering:!0}),s=new Mesh(e,t);this.add(s)}}class SceneView extends Group{constructor(){super(),this.visible=!1,this.initViews()}initViews(){this.ball=new Ball,this.add(this.ball),this.mallet=new Mallet,this.add(this.mallet)}}class SceneController{static init(e){this.view=e,this.initPhysics(),this.addListeners()}static initPhysics(){this.physics=new ScenePhysicsController(this.view)}static addListeners(){Stage.element.addEventListener("touchstart",this.onTouchStart),Stage.element.addEventListener("mousedown",this.onTouchStart),window.addEventListener("touchmove",this.onTouchMove),window.addEventListener("mousemove",this.onTouchMove)}}SceneController.onTouchStart=e=>{e.preventDefault(),SceneController.onTouchMove(e)},SceneController.onTouchMove=e=>{if(!SceneController.view.visible)return;const t={};e.changedTouches&&e.changedTouches.length?(t.x=e.changedTouches[0].clientX,t.y=e.changedTouches[0].clientY):(t.x=e.clientX,t.y=e.clientY),SceneController.send(t)},SceneController.resize=(e,t)=>{SceneController.width=e,SceneController.height=t;const s=WorldController.getFrustum(SceneController.view.mallet.position.z);SceneController.physics.resize(s.width,s.height)},SceneController.update=()=>{SceneController.physics.update()},SceneController.send=e=>{SceneController.physics.send("motion",{x:e.x/SceneController.width,y:e.y/SceneController.height})},SceneController.animateIn=()=>{SceneController.view.visible=!0},SceneController.ready=()=>SceneController.physics.ready();class AudioController{static init(e){this.view=e,this.addListeners()}static addListeners(){Stage.events.on(Events.VISIBILITY,this.onVisibility),Stage.element.addEventListener("touchstart",this.onTouchStart),Stage.element.addEventListener("mousedown",this.onTouchStart)}}AudioController.onVisibility=()=>{document.hidden?WebAudio.mute():WebAudio.unmute()},AudioController.onTouchStart=()=>{Stage.element.removeEventListener("touchstart",AudioController.onTouchStart),Stage.element.removeEventListener("mousedown",AudioController.onTouchStart),AudioController.trigger("gong",500)},AudioController.trigger=(e,...t)=>{if(WebAudio.context)switch(e){case"gong":{const e=new Sound3D(WorldController.camera,"gong");AudioController.view.ball.add(e),AudioController.view.ball.updateMatrixWorld();const s=range(t[0],0,1e3,0,1,!0);e.sound.gain.alpha=.5*s,e.sound.playbackRate.alpha=clamp(.8+.4*s,.8,1.2),e.sound.play(),delayedCall(6e3,()=>{AudioController.view.ball.remove(e),e.destroy()});break}}};class RenderManager{static init(e,t,s){this.renderer=e,this.scene=t,this.camera=s,this.initRenderer()}static initRenderer(){}}RenderManager.resize=(e,t,s)=>{RenderManager.renderer.setPixelRatio(s),RenderManager.renderer.setSize(e,t)},RenderManager.update=()=>{RenderManager.renderer.render(RenderManager.scene,RenderManager.camera)};class WorldController{static init(){this.initWorld(),this.initLights()}static initWorld(){this.renderer=new WebGL1Renderer({powerPreference:"high-performance",stencil:!1}),this.element=this.renderer.domElement,this.scene=new Scene,this.scene.background=new Color(Config.BG_COLOR),this.scene.fog=new Fog(Config.BG_COLOR,1,62.5),this.camera=new PerspectiveCamera(30),this.camera.near=.1,this.camera.far=1e3,this.camera.position.z=37.5,this.resolution=new Uniform(new Vector2),this.aspect=new Uniform(1),this.time=new Uniform(0),this.frame=new Uniform(0)}static initLights(){this.scene.add(new HemisphereLight(6316128,4210752));const e=new DirectionalLight(16777215);e.position.set(1,1,1),this.scene.add(e)}}WorldController.resize=(e,t,s)=>{WorldController.camera.aspect=e/t,WorldController.camera.updateProjectionMatrix(),e=Math.round(e*s),t=Math.round(t*s),WorldController.resolution.value.set(e,t),WorldController.aspect.value=e/t},WorldController.update=(e,t,s)=>{WorldController.time.value=e,WorldController.frame.value=s},WorldController.getFrustum=e=>getFrustum(WorldController.camera,e);class App{static async init(){Assets.cache=!0,this.last=performance.now(),this.delta=0,this.time=0,this.frame=0,this.initWorld(),this.initViews(),this.initControllers(),this.initLoader(),this.addListeners(),this.onResize(),await SceneController.ready(),SceneController.animateIn()}static initWorld(){WorldController.init(),Stage.add(WorldController.element)}static initViews(){this.view=new SceneView,WorldController.scene.add(this.view)}static initControllers(){const{renderer:e,scene:t,camera:s}=WorldController;SceneController.init(this.view),RenderManager.init(e,t,s)}static initLoader(){this.loader=new AssetLoader(Config.ASSETS)}static addListeners(){Stage.events.on(Events.RESIZE,this.onResize),SceneController.physics.thread?(gsap.ticker.remove(gsap.updateRoot),SceneController.physics.thread.on("update",()=>{gsap.updateRoot(this.time),this.onUpdate(this.time,this.delta,this.frame),requestAnimationFrame(this.onStep)}),requestAnimationFrame(this.onStep)):ticker.add(this.onUpdate),this.loader.events.on(Events.COMPLETE,this.onComplete)}}App.onResize=()=>{const{width:e,height:t,dpr:s}=Stage;WorldController.resize(e,t,s),SceneController.resize(e,t),RenderManager.resize(e,t,s)},App.onUpdate=(e,t,s)=>{WorldController.update(e,t,s),SceneController.update(),RenderManager.update(e,t,s)},App.onStep=e=>{App.delta=e-App.last,App.last=e,App.time=.001*e,App.frame++,SceneController.physics.thread.update()},App.onComplete=async()=>{App.loader=App.loader.destroy(),WebAudio.init(Assets.filter(e=>/sounds/.test(e))),AudioController.init(App.view)},App.init();</script>
</body>
</html>
