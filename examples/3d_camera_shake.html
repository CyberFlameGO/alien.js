<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Alien.js â€” 3D Camera Shake</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div id="root"></div>
    <script type="module">import{AssetLoader,Assets,Color,CylinderBufferGeometry,Device,DirectionalLight,EventEmitter,Events,Fog,Group,HemisphereLight,MathUtils,Mesh,MeshStandardMaterial,PerspectiveCamera,PlaneBufferGeometry,PointLight,Reflector,RepeatWrapping,Scene,Sound3D,SphereBufferGeometry,Stage,TextureLoader,Thread,Uniform,Vector2,Vector3,WebAudio,WebGL1Renderer,Wobble,clamp,clearTween,delayedCall,getFrustum,gsap,radians,range,ticker,tween}from"../build/alien.js";import{World}from"https://unpkg.com/oimo/build/oimo.module.js";class Config{}Config.BG_COLOR="#0e0e0e",Config.UI_COLOR="rgba(255, 255, 255, 0.94)",Config.ASSETS=["assets/sounds/gong.mp3"];class ScenePhysics extends EventEmitter{constructor(e){super(),this.resize=(e,t)=>{this.width=e,this.height=t},this.update=()=>{this.world.step();let e=0;this.bodies.forEach((t,r)=>{e=8*r,t.sleeping?this.buffer[e+7]=1:(this.buffer[e+7]=0,t.getPosition().toArray(this.buffer,e),t.getQuaternion().toArray(this.buffer,e+3))}),this.emit("update",{buffer:this.buffer});const t=this.bodies[0],r=this.bodies[1],o=this.bodies[2];this.mouse.lerp(this.target,this.lerpSpeed),this.malletPosition.x=this.mouse.x*(.5*this.width),this.malletPosition.y=this.mouse.y*(.5*this.height),this.malletPosition.z=o.position.z,o.setPosition(this.malletPosition);const i=this.world.getContact(r,t);if(i&&!this.timeout){this.force.x+=t.linearVelocity.x*t.mass-r.linearVelocity.x*r.mass,this.force.y+=t.linearVelocity.y*t.mass-r.linearVelocity.y*r.mass,this.force.z+=t.linearVelocity.z*t.mass-r.linearVelocity.z*r.mass,this.force.multiplyScalar(.5);const e=this.force.length();(e>150||!i.close)&&(this.timeout=!0,this.emit("contact",{force:e}),delayedCall(250,()=>{this.timeout=!1}))}},this.motion=({x:e,y:t})=>{this.target.set(2*e-1,-2*t+1)},this.shapes=e,this.bodies=[],this.force=new Vector3,this.mouse=new Vector2,this.target=new Vector2,this.malletPosition=new Vector3,this.timeout=!1,this.lerpSpeed=.25,this.initWorld()}initWorld(){this.world=new World,this.world.gravity=new Vector3(0,-98,0),this.shapes.forEach(e=>this.bodies.push(this.world.add(e)));const e=this.bodies[1];this.world.add({type:"joint",body1:"paddle",body2:"wand",pos1:[0,0,0],pos2:[0,e.shapes.halfHeight,0]}),this.buffer=new Float32Array(8*this.shapes.length)}}class ScenePhysicsThread{constructor(){this.onMessage=({data:e})=>{this[e.message.fn].call(this,e.message)},this.onUpdate=({buffer:e})=>{postMessage({event:"update",message:{buffer:e}})},this.onContact=({force:e})=>{postMessage({event:"contact",message:{force:e}})},this.init=({shapes:e})=>{this.physics=new ScenePhysics(e),this.physics.on("update",this.onUpdate),this.physics.on("contact",this.onContact),postMessage({event:"ready"})},this.resize=({width:e,height:t})=>{this.physics.resize(e,t)},this.update=()=>{this.physics.update()},this.motion=e=>{this.physics.motion(e)},this.addListeners()}addListeners(){addEventListener("message",this.onMessage)}}class ScenePhysicsController{constructor(e){this.onReady=()=>{this.resolve()},this.onUpdate=({buffer:e})=>{this.buffer=e},this.onContact=({force:e})=>{AudioController.trigger("gong",e),CameraController.shake(e)},this.resize=(e,t)=>{this.thread?this.thread.resize({width:e,height:t}):this.physics.resize(e,t)},this.update=()=>{this.physics&&this.physics.update();let e=0;this.meshes.forEach((t,r)=>{e=8*r,1!==this.buffer[e+7]&&(t.position.fromArray(this.buffer,e),t.quaternion.fromArray(this.buffer,e+3))})},this.send=(e,t={})=>{this.thread?this.thread.send(e,t):this.physics[e].call(this.physics,t)},this.ready=()=>this.promise,this.view=e,this.meshes=[],this.shapes=[],this.promise=new Promise(e=>this.resolve=e),this.initBuffer(),this.initEngine(),this.addListeners()}initBuffer(){const{floor:e,wand:t,mallet:r}=this.view;this.meshes.push(e),this.shapes.push(this.createShapeObject("floor","box",e.position,e.rotation,e.size)),this.meshes.push(t),this.shapes.push(this.createShapeObject("wand","cylinder",t.position,t.rotation,t.size,!0)),this.meshes.push(r),this.shapes.push(this.createShapeObject("paddle","sphere",r.position,r.rotation,r.size,!0,!0)),this.buffer=new Float32Array(8*this.shapes.length)}initEngine(){Device.agent.includes("chrome")?(this.thread=new Thread({imports:[["../build/alien.js","EventEmitter","Vector2","Vector3","delayedCall"],["https://unpkg.com/oimo/build/oimo.module.js","World"]],classes:[ScenePhysics],controller:[ScenePhysicsThread,"init","resize","update"]}),this.thread.init({shapes:this.shapes})):this.physics=new ScenePhysics(this.shapes)}createShapeObject(e,t,r,o,i,s,n){const a={};a.name=e,a.type=t,a.pos=[r.x,r.y,r.z],a.rot=[MathUtils.radToDeg(o.x),MathUtils.radToDeg(o.y),MathUtils.radToDeg(o.z)],a.move=s,a.noSleep=s,"box"===t&&(a.size=[i.x,i.y,i.z]),"sphere"===t&&(a.size=[i.x]),"cylinder"===t&&(a.size=[i.x,i.z]);const l=[20,0,0,1,4294967295];return n&&(l[0]=100,a.kinematic=!0),a.config=l,a}addListeners(){this.thread?(this.thread.on("ready",this.onReady),this.thread.on("update",this.onUpdate),this.thread.on("contact",this.onContact)):(this.physics.on("update",this.onUpdate),this.physics.on("contact",this.onContact),this.resolve())}}class Mallet extends Group{constructor(){super(),this.initMesh(),this.initLight()}initMesh(){this.size=new Vector3(.5,.5,.5),this.geometry=new SphereBufferGeometry(.5,24,24),this.material=new MeshStandardMaterial({emissive:16777215}),this.mesh=new Mesh(this.geometry,this.material),this.add(this.mesh)}initLight(){this.light=new PointLight(16777215,.2),this.add(this.light)}}class Wand extends Group{constructor(){super(),this.initMesh()}initMesh(){this.size=new Vector3(.75,.75,3),this.geometry=new CylinderBufferGeometry(.75,.75,3,50),this.material=new MeshStandardMaterial({emissive:16777215}),this.mesh=new Mesh(this.geometry,this.material),this.add(this.mesh)}}class Floor extends Group{constructor(){super(),this.position.y=-4.5,this.initMesh()}initMesh(){const{getTexture:e}=WorldController;this.size=new Vector3(1e3,3,1e3),this.geometry=new PlaneBufferGeometry(1e3,1e3);const t=e("assets/textures/pbr/polished_concrete_basecolor.jpg");t.wrapS=RepeatWrapping,t.wrapT=RepeatWrapping,t.repeat.set(8,8),this.mesh=new Reflector(this.geometry,{map:t}),this.mesh.position.y=this.size.y/2,this.mesh.rotation.x=-Math.PI/2,this.add(this.mesh)}}class SceneView extends Group{constructor(){super(),this.visible=!1,this.initViews()}initViews(){this.floor=new Floor,this.add(this.floor),this.wand=new Wand,this.add(this.wand),this.mallet=new Mallet,this.add(this.mallet)}}class SceneController{static init(e){this.view=e,this.initPhysics(),this.addListeners()}static initPhysics(){this.physics=new ScenePhysicsController(this.view)}static addListeners(){Stage.element.addEventListener("touchstart",this.onTouchStart),Stage.element.addEventListener("mousedown",this.onTouchStart),window.addEventListener("touchmove",this.onTouchMove),window.addEventListener("mousemove",this.onTouchMove)}}SceneController.onTouchStart=e=>{e.preventDefault(),SceneController.onTouchMove(e)},SceneController.onTouchMove=e=>{if(!SceneController.view.visible)return;const t={};e.changedTouches&&e.changedTouches.length?(t.x=e.changedTouches[0].clientX,t.y=e.changedTouches[0].clientY):(t.x=e.clientX,t.y=e.clientY),SceneController.send(t)},SceneController.resize=(e,t)=>{SceneController.width=e,SceneController.height=t;const r=WorldController.getFrustum(SceneController.view.mallet.position.z);SceneController.physics.resize(r.width,r.height)},SceneController.update=()=>{SceneController.physics.update()},SceneController.send=e=>{SceneController.physics.send("motion",{x:e.x/SceneController.width,y:e.y/SceneController.height})},SceneController.animateIn=()=>{SceneController.view.visible=!0},SceneController.ready=()=>SceneController.physics.ready();class AudioController{static init(e){this.view=e,this.addListeners()}static addListeners(){Stage.events.on(Events.VISIBILITY,this.onVisibility),Stage.element.addEventListener("touchstart",this.onTouchStart),Stage.element.addEventListener("mousedown",this.onTouchStart)}}AudioController.onVisibility=()=>{document.hidden?WebAudio.mute():WebAudio.unmute()},AudioController.onTouchStart=()=>{Stage.element.removeEventListener("touchstart",AudioController.onTouchStart),Stage.element.removeEventListener("mousedown",AudioController.onTouchStart),AudioController.trigger("gong",500)},AudioController.trigger=(e,...t)=>{if(WebAudio.context)switch(e){case"gong":{const e=new Sound3D(WorldController.camera,"gong");e.position.copy(AudioController.view.wand.position),e.quaternion.copy(AudioController.view.wand.quaternion),e.updateMatrixWorld();const r=range(t[0],0,1e3,0,1,!0);e.sound.gain.alpha=.5*r,e.sound.playbackRate.alpha=clamp(.8+.4*r,.8,1.2),e.sound.play(),delayedCall(6e3,()=>{e.destroy()});break}}};class RenderManager{static init(e,t,r){this.renderer=e,this.scene=t,this.camera=r,this.initRenderer()}static initRenderer(){}}RenderManager.resize=(e,t,r)=>{RenderManager.renderer.setPixelRatio(r),RenderManager.renderer.setSize(e,t)},RenderManager.update=()=>{RenderManager.renderer.render(RenderManager.scene,RenderManager.camera)};class CameraController{static init(e){this.camera=e,this.group=new Group,this.rotateGroup=new Group,this.group.add(this.rotateGroup),this.group.matrixAutoUpdate=!1,this.rotateGroup.matrixAutoUpdate=!1,this.group.position.copy(this.camera.position),this.rotateGroup.rotation.y=Math.PI,this.mouse=new Vector2,this.last=new Vector2,this.delta=new Vector2,this.mouse.set(Stage.width/2,Stage.height/2),this.last.copy(this.mouse),this.lookAt=new Vector3(0,0,-2),this.origin=new Vector3,this.target=new Vector3,this.targetXY=new Vector2(18.75,1),this.origin.copy(this.group.position),this.rotation=0,this.rotateAngle=radians(40),this.multiplier=0,this.lerpSpeed=.02,this.lerpSpeed2=.07,this.enabled=!1,this.wobble=new Wobble,this.wobble.amplitude.set(15,15,15),this.wobble.frequency.set(15,15,15),this.addListeners()}static addListeners(){Stage.element.addEventListener("touchstart",this.onTouchStart),Stage.element.addEventListener("mousedown",this.onTouchStart),window.addEventListener("touchmove",this.onTouchMove),window.addEventListener("mousemove",this.onTouchMove)}}CameraController.onTouchStart=e=>{e.preventDefault(),CameraController.onTouchMove(e)},CameraController.onTouchMove=e=>{const t={};e.changedTouches&&e.changedTouches.length?(t.x=e.changedTouches[0].clientX,t.y=e.changedTouches[0].clientY):(t.x=e.clientX,t.y=e.clientY),CameraController.mouse.copy(t)},CameraController.resize=(e,t)=>{CameraController.camera.aspect=e/t,CameraController.camera.updateProjectionMatrix()},CameraController.update=e=>{if(!CameraController.enabled)return;CameraController.delta.subVectors(CameraController.mouse,CameraController.last),CameraController.last.copy(CameraController.mouse);const t=range(CameraController.mouse.x,0,Stage.width,-1,1,!0),r=range(CameraController.mouse.y,0,Stage.height,-1,1,!0);CameraController.wobble.update(e),CameraController.target.x=CameraController.origin.x+CameraController.wobble.target.x*CameraController.multiplier+CameraController.targetXY.x*t,CameraController.target.y=CameraController.origin.y+CameraController.wobble.target.y*CameraController.multiplier+CameraController.targetXY.y*r,CameraController.target.z=CameraController.origin.z+CameraController.wobble.target.z*CameraController.multiplier,CameraController.group.position.lerp(CameraController.target,CameraController.lerpSpeed),CameraController.group.lookAt(CameraController.lookAt);const o=range(Math.abs(CameraController.delta.x)/Stage.width,0,.02,0,1,!0)*CameraController.multiplier;CameraController.rotation+=(CameraController.rotateAngle*o*t-CameraController.rotation)*CameraController.lerpSpeed,CameraController.rotateGroup.rotation.z+=(CameraController.rotation-CameraController.rotateGroup.rotation.z)*CameraController.lerpSpeed2,CameraController.updateCamera()},CameraController.updateCamera=()=>{CameraController.group.updateMatrix(),CameraController.rotateGroup.updateMatrix(),CameraController.group.updateMatrixWorld(),CameraController.rotateGroup.matrixWorld.decompose(CameraController.camera.position,CameraController.camera.quaternion,CameraController.camera.scale)},CameraController.animateIn=()=>{CameraController.enabled=!0},CameraController.shake=e=>{const t=range(e,0,1e3,0,1,!0);clearTween(CameraController),tween(CameraController,{multiplier:t},50,"easeOutExpo",()=>{tween(CameraController,{multiplier:0},300,"easeInExpo")})};class WorldController{static init(){this.initWorld(),this.initLights(),this.initLoaders()}static initWorld(){this.renderer=new WebGL1Renderer({powerPreference:"high-performance",stencil:!1}),this.element=this.renderer.domElement,this.scene=new Scene,this.scene.background=new Color(Config.BG_COLOR),this.scene.fog=new Fog(Config.BG_COLOR,1,62.5),this.camera=new PerspectiveCamera(30),this.camera.near=.1,this.camera.far=1e3,this.camera.position.z=37.5,this.resolution=new Uniform(new Vector2),this.aspect=new Uniform(1),this.time=new Uniform(0),this.frame=new Uniform(0)}static initLights(){this.scene.add(new HemisphereLight(6316128,4210752));const e=new DirectionalLight(16777215);e.position.set(1,1,1),this.scene.add(e)}static initLoaders(){this.textureLoader=new TextureLoader}}WorldController.resize=(e,t,r)=>{e=Math.round(e*r),t=Math.round(t*r),WorldController.resolution.value.set(e,t),WorldController.aspect.value=e/t},WorldController.update=(e,t,r)=>{WorldController.time.value=e,WorldController.frame.value=r},WorldController.getTexture=e=>WorldController.textureLoader.load(e),WorldController.getFrustum=e=>getFrustum(WorldController.camera,e);class App{static async init(){Assets.cache=!0,this.last=performance.now(),this.delta=0,this.time=0,this.frame=0,this.initWorld(),this.initViews(),this.initControllers(),this.initLoader(),this.addListeners(),this.onResize(),await Promise.all([WorldController.textureLoader.ready(),SceneController.ready()]),CameraController.animateIn(),SceneController.animateIn()}static initWorld(){WorldController.init(),Stage.add(WorldController.element)}static initViews(){this.view=new SceneView,WorldController.scene.add(this.view)}static initControllers(){const{renderer:e,scene:t,camera:r}=WorldController;CameraController.init(r,this.view),SceneController.init(this.view),RenderManager.init(e,t,r)}static initLoader(){this.loader=new AssetLoader(Config.ASSETS)}static addListeners(){Stage.events.on(Events.RESIZE,this.onResize),SceneController.physics.thread?(gsap.ticker.remove(gsap.updateRoot),SceneController.physics.thread.on("update",()=>{gsap.updateRoot(this.time),this.onUpdate(this.time,this.delta,this.frame),requestAnimationFrame(this.onStep)}),requestAnimationFrame(this.onStep)):ticker.add(this.onUpdate),this.loader.events.on(Events.COMPLETE,this.onComplete)}}App.onResize=()=>{const{width:e,height:t,dpr:r}=Stage;WorldController.resize(e,t,r),CameraController.resize(e,t),SceneController.resize(e,t),RenderManager.resize(e,t,r)},App.onUpdate=(e,t,r)=>{WorldController.update(e,t,r),CameraController.update(e),SceneController.update(),RenderManager.update(e,t,r)},App.onStep=e=>{App.delta=e-App.last,App.last=e,App.time=.001*e,App.frame++,SceneController.physics.thread.update()},App.onComplete=async()=>{App.loader=App.loader.destroy(),WebAudio.init(Assets.filter(e=>/sounds/.test(e))),AudioController.init(App.view)},App.init();</script>
</body>
</html>
