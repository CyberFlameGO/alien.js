<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Alien.js â€” Shader Flowmap View</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div id="root"></div>
    <script type="module">import{ACESFilmicToneMapping,AdditiveBlending,BloomCompositeMaterial,BlurDirectionX,BlurDirectionY,Color,DirectionalLight,Events,FXAAMaterial,Flowmap,Fog,Group,HemisphereLight,LuminosityMaterial,Mesh,MeshStandardMaterial,NoBlending,OrthographicCamera,PerspectiveCamera,PlaneGeometry,RGBFormat,RawShaderMaterial,Reflector,RepeatWrapping,SVGLoader,Scene,Stage,TextureLoader,Uniform,UnrealBloomBlurMaterial,Vector2,Vector3,WebGL1Renderer,WebGLRenderTarget,getFrustum,getFullscreenTriangle,mix,range,ticker}from"../build/alien.js";class Config{}Config.BG_COLOR="#0e0e0e",Config.UI_COLOR="rgba(255, 255, 255, 0.94)";import rgbshift from"../src/shaders/modules/rgbshift/rgbshift.glsl.js";const vertexFlowShader="\n            attribute vec2 uv;\n            attribute vec3 position;\n\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            varying vec2 vUv;\n\n            void main() {\n                vUv = uv;\n\n                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n            }\n        ",fragmentFlowShader=`\n            precision highp float;\n\n            uniform sampler2D tMap;\n            uniform sampler2D tFlow;\n            uniform float uDistortion;\n\n            varying vec2 vUv;\n\n            ${rgbshift}\n\n            void main() {\n                // R and G values are velocity in the X and Y direction\n                // B value is the velocity length\n                vec3 flow = texture2D(tFlow, vUv).rgb;\n\n                // Use flow to adjust the UV lookup of a texture\n                vec2 uv = vUv;\n                uv += flow.rg * 0.05;\n\n                float angle = length(vUv - vec2(0.5));\n                float amount = uDistortion + length(flow.rg) * 0.025;\n\n                gl_FragColor = getRGB(tMap, uv, angle, amount);\n                gl_FragColor.a = 1.0;\n            }\n        `;class FlowMaterial extends RawShaderMaterial{constructor(){super({uniforms:{tMap:new Uniform(null),tFlow:new Uniform(null),uDistortion:new Uniform(.00125)},vertexShader:vertexFlowShader,fragmentShader:fragmentFlowShader,blending:AdditiveBlending,transparent:!0})}}const vertexCompositeShader="\n            attribute vec2 uv;\n            attribute vec3 position;\n\n            varying vec2 vUv;\n\n            void main() {\n                vUv = uv;\n\n                gl_Position = vec4(position, 1.0);\n            }\n        ",fragmentCompositeShader=`\n            precision highp float;\n\n            uniform sampler2D tScene;\n            uniform sampler2D tBloom;\n            uniform float uDistortion;\n\n            varying vec2 vUv;\n\n            ${rgbshift}\n\n            void main() {\n                gl_FragColor = texture2D(tScene, vUv);\n\n                float angle = length(vUv - vec2(0.5));\n                float amount = uDistortion + 0.0002;\n\n                gl_FragColor.rgb += getRGB(tBloom, vUv, angle, amount).rgb;\n            }\n        `;class CompositeMaterial extends RawShaderMaterial{constructor(){super({uniforms:{tScene:new Uniform(null),tBloom:new Uniform(null),uDistortion:new Uniform(.00125)},vertexShader:vertexCompositeShader,fragmentShader:fragmentCompositeShader,blending:NoBlending,depthWrite:!1,depthTest:!1})}}class Triangle extends Group{constructor(){super()}async initMesh(){const{loadSVG:e}=WorldController,r=(await e('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"><path stroke-width="0.3" d="M3 0L0 5h6z"/></svg>')).paths,t=new Group;t.scale.y*=-1;for(let e=0,n=r.length;e<n;e++){const n=r[e],o=new MeshStandardMaterial({emissive:16777215});for(let e=0,r=n.subPaths.length;e<r;e++){const r=n.subPaths[e],a=SVGLoader.pointsToStroke(r.getPoints(),n.userData.style);if(a){a.center();const e=new Mesh(a,o);t.add(e)}}}this.add(t)}}class TriangleView extends Group{constructor(){super(),this.resize=(e,r,t)=>{const n=WorldController.getFrustum(this.mesh.position.z);this.widthResolutionScale=this.width/n.width,this.heightResolutionScale=this.height/n.height,e=Math.round(e*t*this.widthResolutionScale),r=Math.round(r*t*this.heightResolutionScale),this.renderTarget.setSize(e,r),this.isLoaded&&this.update()},this.update=()=>{const e=this.renderer.getRenderTarget();this.renderer.setRenderTarget(this.renderTarget),this.renderer.render(this.scene,this.camera),this.renderer.setRenderTarget(e)},this.ready=async()=>{await this.triangle.initMesh(),this.isLoaded=!0,this.update()},this.width=8,this.height=6,this.isLoaded=!1,this.initRenderer(),this.initMesh(),this.initViews()}initRenderer(){const{aspect:e,renderer:r}=WorldController;this.renderer=r,this.scene=new Scene,this.camera=new OrthographicCamera,this.camera.left=-this.width/2,this.camera.right=this.width/2,this.camera.top=this.height/2,this.camera.bottom=-this.height/2,this.camera.near=0,this.camera.far=1,this.camera.updateProjectionMatrix(),this.renderTarget=new WebGLRenderTarget(1,1),this.flowmap=new Flowmap(this.renderer,{alpha:.25}),this.flowmap.material.uniforms.uAspect=e}initMesh(){const{camera:e,quad:r}=WorldController,t=new FlowMaterial;t.uniforms.tMap.value=this.renderTarget.texture,t.uniforms.tFlow=this.flowmap.uniform;const n=new Mesh(r,t);n.position.set(0,1.4,-11),n.scale.set(this.width,this.height,1),n.lookAt(e.position),this.add(n),this.mesh=n}initViews(){this.triangle=new Triangle,this.triangle.frustumCulled=!1,this.triangle.scale.multiplyScalar(.8),this.scene.add(this.triangle)}}class Floor extends Group{constructor(){super(),this.initMesh()}initMesh(){const{getTexture:e,quad:r,scene:t}=WorldController,n=e("assets/textures/pbr/polished_concrete_basecolor.jpg");n.wrapS=RepeatWrapping,n.wrapT=RepeatWrapping,n.repeat.set(8,8);const{fog:o}=t,a=new Reflector(r,{width:512,height:640,map:n,fog:o,dithering:!0});a.position.y=-1.6,a.rotation.x=-Math.PI/2,a.scale.set(110,110,1),a.renderOrder=-1,this.add(a)}}class SceneView extends Group{constructor(){super(),this.visible=!1,this.initViews()}initViews(){this.floor=new Floor,this.add(this.floor),this.triangle=new TriangleView,this.add(this.triangle)}}class SceneController{static init(e,r){this.camera=e,this.view=r,this.mouse=new Vector2(-1,-1),this.velocity=new Vector2,this.lastTime=null,this.lastMouse=new Vector2,this.triangleWorldPosition=new Vector3,this.screenSpacePosition=new Vector3,this.addListeners()}static addListeners(){Stage.element.addEventListener("touchstart",this.onTouchStart),Stage.element.addEventListener("mousedown",this.onTouchStart),window.addEventListener("touchmove",this.onTouchMove),window.addEventListener("mousemove",this.onTouchMove)}}SceneController.onTouchStart=e=>{e.preventDefault(),SceneController.onTouchMove(e)},SceneController.onTouchMove=e=>{if(!SceneController.view.visible)return;const r={};e.changedTouches&&e.changedTouches.length?(r.x=e.changedTouches[0].clientX,r.y=e.changedTouches[0].clientY):(r.x=e.clientX,r.y=e.clientY);const t=SceneController.width/2,n=SceneController.height/2,o=Math.round(SceneController.width*SceneController.view.triangle.widthResolutionScale),a=Math.round(SceneController.height*SceneController.view.triangle.heightResolutionScale),i=o/2,l=a/2;SceneController.triangleWorldPosition.setFromMatrixPosition(SceneController.view.triangle.mesh.matrixWorld),SceneController.screenSpacePosition.copy(SceneController.triangleWorldPosition).project(SceneController.camera),SceneController.screenSpacePosition.x=SceneController.screenSpacePosition.x*t+t-i,SceneController.screenSpacePosition.y=-SceneController.screenSpacePosition.y*n+n-l,SceneController.mouse.set(range(r.x,SceneController.screenSpacePosition.x,SceneController.screenSpacePosition.x+o,0,1),1-range(r.y,SceneController.screenSpacePosition.y,SceneController.screenSpacePosition.y+a,0,1)),SceneController.lastTime||(SceneController.lastTime=performance.now(),SceneController.lastMouse.copy(r));const s=r.x-SceneController.lastMouse.x,c=r.y-SceneController.lastMouse.y;SceneController.lastMouse.copy(r);const d=performance.now(),h=Math.max(14,d-SceneController.lastTime);SceneController.lastTime=d,SceneController.velocity.x=s/h,SceneController.velocity.y=c/h,SceneController.velocity.needsUpdate=!0},SceneController.resize=(e,r,t)=>{SceneController.width=e,SceneController.height=r,SceneController.view.triangle.resize(e,r,t)},SceneController.update=()=>{SceneController.velocity.needsUpdate||(SceneController.mouse.set(-1,-1),SceneController.velocity.set(0,0),SceneController.lastTime=null),SceneController.velocity.needsUpdate=!1,SceneController.view.triangle.flowmap.mouse.copy(SceneController.mouse),SceneController.view.triangle.flowmap.velocity.lerp(SceneController.velocity,SceneController.velocity.length()?.5:.1),SceneController.view.triangle.flowmap.update()},SceneController.animateIn=()=>{SceneController.view.visible=!0},SceneController.ready=()=>SceneController.view.triangle.ready();class RenderManager{static init(e,r,t){this.renderer=e,this.scene=r,this.camera=t,this.luminosityThreshold=.1,this.bloomStrength=.3,this.bloomRadius=.75,this.enabled=!0,this.initRenderer()}static initRenderer(){const{resolution:e,screenTriangle:r}=WorldController;this.screenScene=new Scene,this.screenCamera=new OrthographicCamera(-1,1,1,-1,0,1),this.screen=new Mesh(r),this.screen.frustumCulled=!1,this.screenScene.add(this.screen),this.renderTargetA=new WebGLRenderTarget(1,1,{format:RGBFormat,anisotropy:0,depthBuffer:!1}),this.renderTargetB=this.renderTargetA.clone(),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5,this.renderTargetBright=this.renderTargetA.clone();for(let e=0,r=this.nMips;e<r;e++)this.renderTargetsHorizontal.push(this.renderTargetA.clone()),this.renderTargetsVertical.push(this.renderTargetA.clone());this.renderTargetA.depthBuffer=!0,this.fxaaMaterial=new FXAAMaterial,this.fxaaMaterial.uniforms.uResolution=e,this.luminosityMaterial=new LuminosityMaterial,this.luminosityMaterial.uniforms.uLuminosityThreshold.value=this.luminosityThreshold,this.blurMaterials=[];const t=[3,5,7,9,11];for(let e=0,r=this.nMips;e<r;e++)this.blurMaterials.push(new UnrealBloomBlurMaterial(t[e])),this.blurMaterials[e].uniforms.uResolution.value=new Vector2;const n=[1,.8,.6,.4,.2];for(let e=0,r=this.nMips;e<r;e++){const r=n[e];n[e]=this.bloomStrength*mix(r,1.2-r,this.bloomRadius)}this.bloomCompositeMaterial=new BloomCompositeMaterial(this.nMips),this.bloomCompositeMaterial.uniforms.tBlur1.value=this.renderTargetsVertical[0].texture,this.bloomCompositeMaterial.uniforms.tBlur2.value=this.renderTargetsVertical[1].texture,this.bloomCompositeMaterial.uniforms.tBlur3.value=this.renderTargetsVertical[2].texture,this.bloomCompositeMaterial.uniforms.tBlur4.value=this.renderTargetsVertical[3].texture,this.bloomCompositeMaterial.uniforms.tBlur5.value=this.renderTargetsVertical[4].texture,this.bloomCompositeMaterial.uniforms.uBloomFactors.value=n,this.compositeMaterial=new CompositeMaterial}}RenderManager.resize=(e,r,t)=>{RenderManager.renderer.setPixelRatio(t),RenderManager.renderer.setSize(e,r),e=Math.round(e*t),r=Math.round(r*t),RenderManager.renderTargetA.setSize(e,r),RenderManager.renderTargetB.setSize(e,r),e=Math.round(e/2),r=Math.round(r/2),RenderManager.renderTargetBright.setSize(e,r);for(let t=0,n=RenderManager.nMips;t<n;t++)RenderManager.renderTargetsHorizontal[t].setSize(e,r),RenderManager.renderTargetsVertical[t].setSize(e,r),RenderManager.blurMaterials[t].uniforms.uResolution.value.set(e,r),e=Math.round(e/2),r=Math.round(r/2)},RenderManager.update=()=>{const e=RenderManager.renderer,r=RenderManager.scene,t=RenderManager.camera;if(!RenderManager.enabled)return e.setRenderTarget(null),void e.render(r,t);const n=RenderManager.screenScene,o=RenderManager.screenCamera,a=RenderManager.renderTargetA,i=RenderManager.renderTargetB,l=RenderManager.renderTargetBright,s=RenderManager.renderTargetsHorizontal,c=RenderManager.renderTargetsVertical;e.setRenderTarget(a),e.render(r,t),RenderManager.fxaaMaterial.uniforms.tMap.value=a.texture,RenderManager.screen.material=RenderManager.fxaaMaterial,e.setRenderTarget(i),e.render(n,o),RenderManager.luminosityMaterial.uniforms.tMap.value=i.texture,RenderManager.screen.material=RenderManager.luminosityMaterial,e.setRenderTarget(l),e.render(n,o);let d=l;for(let r=0,t=RenderManager.nMips;r<t;r++)RenderManager.screen.material=RenderManager.blurMaterials[r],RenderManager.blurMaterials[r].uniforms.tMap.value=d.texture,RenderManager.blurMaterials[r].uniforms.uDirection.value=BlurDirectionX,e.setRenderTarget(s[r]),e.render(n,o),RenderManager.blurMaterials[r].uniforms.tMap.value=RenderManager.renderTargetsHorizontal[r].texture,RenderManager.blurMaterials[r].uniforms.uDirection.value=BlurDirectionY,e.setRenderTarget(c[r]),e.render(n,o),d=c[r];RenderManager.screen.material=RenderManager.bloomCompositeMaterial,e.setRenderTarget(s[0]),e.render(n,o),RenderManager.compositeMaterial.uniforms.tScene.value=i.texture,RenderManager.compositeMaterial.uniforms.tBloom.value=s[0].texture,RenderManager.screen.material=RenderManager.compositeMaterial,e.setRenderTarget(null),e.render(n,o)};class CameraController{static init(e){this.camera=e,this.mouse=new Vector2,this.lookAt=new Vector3(0,0,-2),this.origin=new Vector3,this.target=new Vector3,this.targetXY=new Vector2(5,1),this.origin.copy(this.camera.position),this.lerpSpeed=.02,this.enabled=!1,this.addListeners()}static addListeners(){Stage.element.addEventListener("touchstart",this.onTouchStart),Stage.element.addEventListener("mousedown",this.onTouchStart),window.addEventListener("touchmove",this.onTouchMove),window.addEventListener("mousemove",this.onTouchMove)}}CameraController.onTouchStart=e=>{e.preventDefault(),CameraController.onTouchMove(e)},CameraController.onTouchMove=e=>{const r={};e.changedTouches&&e.changedTouches.length?(r.x=e.changedTouches[0].clientX,r.y=e.changedTouches[0].clientY):(r.x=e.clientX,r.y=e.clientY),CameraController.mouse.x=r.x/Stage.width*2-1,CameraController.mouse.y=-r.y/Stage.height*2+1},CameraController.resize=(e,r)=>{CameraController.camera.aspect=e/r,CameraController.camera.updateProjectionMatrix(),CameraController.camera.position.z=e<r?14:10,CameraController.origin.copy(CameraController.camera.position)},CameraController.update=()=>{CameraController.enabled&&(CameraController.target.x=CameraController.origin.x+CameraController.targetXY.x*CameraController.mouse.x,CameraController.target.y=CameraController.origin.y+CameraController.targetXY.y*CameraController.mouse.y,CameraController.target.z=CameraController.origin.z,CameraController.camera.position.lerp(CameraController.target,CameraController.lerpSpeed),CameraController.camera.lookAt(CameraController.lookAt))},CameraController.animateIn=()=>{CameraController.enabled=!0};class WorldController{static init(){this.initWorld(),this.initLights(),this.initLoaders()}static initWorld(){this.renderer=new WebGL1Renderer({powerPreference:"high-performance",stencil:!1}),this.element=this.renderer.domElement,this.renderer.toneMapping=ACESFilmicToneMapping,this.renderer.toneMappingExposure=1,this.scene=new Scene,this.scene.background=new Color(Config.BG_COLOR),this.scene.fog=new Fog(Config.BG_COLOR,1,100),this.camera=new PerspectiveCamera(30),this.camera.near=.5,this.camera.far=50,this.camera.position.z=10,this.quad=new PlaneGeometry(1,1),this.screenTriangle=getFullscreenTriangle(),this.resolution=new Uniform(new Vector2),this.aspect=new Uniform(1),this.time=new Uniform(0),this.frame=new Uniform(0)}static initLights(){this.scene.add(new HemisphereLight(6316128,4210752));const e=new DirectionalLight(16777215);e.position.set(1,1,1),this.scene.add(e)}static initLoaders(){this.textureLoader=new TextureLoader,this.svgLoader=new SVGLoader}}WorldController.resize=(e,r,t)=>{e=Math.round(e*t),r=Math.round(r*t),WorldController.resolution.value.set(e,r),WorldController.aspect.value=e/r},WorldController.update=(e,r,t)=>{WorldController.time.value=e,WorldController.frame.value=t},WorldController.getTexture=e=>WorldController.textureLoader.load(e),WorldController.loadSVG=e=>WorldController.svgLoader.loadAsync(e),WorldController.getFrustum=e=>getFrustum(WorldController.camera,e);class App{static async init(){this.initWorld(),this.initViews(),this.initControllers(),this.addListeners(),this.onResize(),await Promise.all([WorldController.textureLoader.ready(),SceneController.ready()]),CameraController.animateIn(),SceneController.animateIn()}static initWorld(){WorldController.init(),Stage.add(WorldController.element)}static initViews(){this.view=new SceneView,WorldController.scene.add(this.view)}static initControllers(){const{renderer:e,scene:r,camera:t}=WorldController;CameraController.init(t),SceneController.init(t,this.view),RenderManager.init(e,r,t)}static addListeners(){Stage.events.on(Events.RESIZE,this.onResize),ticker.add(this.onUpdate)}}App.onResize=()=>{const{width:e,height:r,dpr:t}=Stage;WorldController.resize(e,r,t),CameraController.resize(e,r),SceneController.resize(e,r,t),RenderManager.resize(e,r,t)},App.onUpdate=(e,r,t)=>{WorldController.update(e,r,t),CameraController.update(),SceneController.update(),RenderManager.update(e,r,t)},App.init();</script>
</body>
</html>
